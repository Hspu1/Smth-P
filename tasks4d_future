


import pytest
import orjson
from httpx import AsyncClient
from app.main import create_app
from app.infra import redis_service

@pytest.fixture
async def client():
    app = create_app(testing=True)
    async with AsyncClient(app=app, base_url="http://test") as ac:
        yield ac

@pytest.fixture
async def auth_client(client, stg):
    """Клиент с уже 'прогретой' сессией в Redis"""
    from itsdangerous import URLSafeSerializer

    session_id = "test_session_123"
    user_data = {
        "user_id": "019c2472-4ae5-7042-bc20-227f877bcc62",
        "given_name": "TestMax"
    }

    # 1. Пишем в Redis (база 15, инициализированная в lifespan)
    await redis_service.client.set(
        f"session:{session_id}:data",
        orjson.dumps(user_data),
        ex=3600
    )

    # 2. Подписываем ID сессии так же, как это делает OrjsonSerializer
    signer = URLSafeSerializer(stg.session_secret_key)
    signed_id = signer.dumps(session_id)

    # 3. Устанавливаем куку в клиент
    client.cookies.set("session_id", signed_id)

    return client
Используйте код с осторожностью.

2. Пример теста
Теперь в тестах тебе не нужно проходить через Google.
python
@pytest.mark.asyncio
async def test_welcome_page_authorized(auth_client):
    response = await auth_client.get("/welcome")
    assert response.status_code == 200
    assert "TestMax" in response.text

